  const uiTranslations = {
            en: {
                pageTitle: "Veo 3 Prompt Generator",
                mainTitle: "Veo 3 Prompt Generator",
                pageDescription: "Craft detailed and effective prompts for Veo 3 with ease.",
                adAreaTop: "Advertisement Area - Top",
                subjectLabel: "1. Subject/Character:",
                subjectPlaceholder: "e.g., A brave knight",
                actionLabel: "2. Action/Activity:",
                actionPlaceholder: "e.g., fighting a dragon",
                expressionLabel: "3. Expression/Emotion:",
                expressionPlaceholder: "e.g., determined and focused",
                placeLabel: "4. Place/Setting:",
                placePlaceholder: "e.g., inside a dark cave",
                timeLabel: "5. Time of Day/Period:",
                selectTimePlaceholder: "-- Select Time --",
                cameraMovementLabel: "6. Camera Movement:",
                selectCameraMovementPlaceholder: "-- Select Camera Movement --",
                lightingLabel: "7. Lighting:",
                selectLightingPlaceholder: "-- Select Lighting --",
                videoStyleLabel: "8. Video Style/Genre:",
                selectVideoStylePlaceholder: "-- Select Video Style --",
                videoAtmosphereLabel: "9. Video Atmosphere/Mood:",
                selectVideoAtmospherePlaceholder: "-- Select Atmosphere --",
                soundMusicLabel: "10. Sound or Music:",
                soundMusicPlaceholder: "e.g., epic orchestral score, soft piano, roaring dragon sounds",
                spokenSentencesLabel: "11. Spoken Sentences (Language):",
                spokenSentencesPlaceholder: "e.g., 'Beware the beast, for its fire burns bright.'",
                additionalDetailsLabel: "12. Additional Details (optional):",
                additionalDetailsPlaceholder: "Any extra specific details, elements, or instructions...",
                adAreaMiddle: "Advertisement Area - Middle",
                generateButton: "Generate Veo 3 Prompt",
                generatedPromptOutputLabel: "Generated Prompt:",
                copyButton: "Copy Prompt",
                translatePromptButton: "Translate Prompt", // New translation key
                selectTranslationLanguagePlaceholder: "-- Select Language --", // New translation key
                translatingPrompt: "Translating prompt...", // New translation key for loading
                translatorErrorMessage: "An error occurred during translation. Please try again.", // New translation key for error
                adAreaBottom: "Advertisement Area - Bottom",
                okButton: "OK",
                messageNoSubject: "Please fill in at least the Subject to generate a basic prompt.",
                messageCopied: "Prompt copied to clipboard!",
                manualCopyRequired: "Failed to copy automatically. Please copy the text manually.", // NEW TRANSLATION KEY
                darkModeOn: "Dark Mode On",
                darkModeOff: "Dark Mode Off",
                languageToggleText: "Bahasa Indonesia",
                visualPrefix: "Visual elements",
                backgroundPrefix: "Background details",
                dynamicCameraPrefix: "Dynamic camera interactions",
                soundDesignPrefix: "Sound design",
                generativeFillSuggestionsTitle: "Generative Fill Suggestions",
                endSuggestionsTitle: "End of Suggestions",
                darkModeText: "Dark Mode", // New: Text for Dark Mode button in mobile menu
                languageText: "Language", // New: Text for Language button in mobile menu
                addSubject: "Add Subject", // New: Add Subject button text
                addSpokenSentence: "Add Sentence", // New: Add Spoken Sentence button text
                remove: "Remove", // New: Remove button text
                speakerPlaceholder: "e.g., Character 1", // New: Speaker placeholder text
                saveSubjects: "Save Subjects", // New: Save Subjects button text
                loadSubjects: "Load Subjects", // New: Load Subjects button text
                clearSubjects: "Clear Subjects", // New: Clear Subjects button text
                savePlace: "Save Place", // New: Save Place button text
                loadPlace: "Load Place", // New: Load Place button text
                clearPlace: "Clear Place", // New: Clear Place button text
                inputsSaved: "Inputs saved successfully!", // New: Message for saved inputs
                noSavedInputs: "No saved inputs found.", // New: Message for no saved inputs
                inputsLoaded: "Inputs loaded successfully!", // New: Message for loaded inputs
                savedInputsCleared: "Saved inputs cleared!", // New: Message for cleared inputs
                randomizeButton: "Randomize Prompt", // New: Randomize Button text
                clearAllInputsButton: "Clear All" // New: Clear All Inputs Button text
            },
            id: {
                pageTitle: "Generator Prompt Veo 3",
                mainTitle: "Generator Prompt Veo 3",
                pageDescription: "Buat prompt yang detail dan efektif untuk Veo 3 dengan mudah.",
                adAreaTop: "Area Iklan - Atas",
                subjectLabel: "1. Subjek/Karakter:",
                subjectPlaceholder: "cth: Seorang ksatria pemberani",
                actionLabel: "2. Aksi/Aktivitas:",
                actionPlaceholder: "cth: melawan naga",
                expressionLabel: "3. Ekspresi/Emosi:",
                expressionPlaceholder: "cth: bertekad dan fokus",
                placeLabel: "4. Tempat/Latar:",
                placePlaceholder: "cth: di dalam gua yang gelap",
                timeLabel: "5. Waktu Hari/Periode:",
                selectTimePlaceholder: "-- Pilih Waktu --",
                cameraMovementLabel: "6. Gerakan Kamera:",
                selectCameraMovementPlaceholder: "-- Pilih Gerakan Kamera --",
                lightingLabel: "7. Pencahayaan:",
                selectLightingPlaceholder: "-- Pilih Pencahayaan --",
                videoStyleLabel: "8. Gaya Video/Genre:",
                selectVideoStylePlaceholder: "-- Pilih Gaya Video --",
                videoAtmosphereLabel: "9. Atmosfer/Suasana Video:",
                selectVideoAtmospherePlaceholder: "-- Pilih Atmosfer --",
                soundMusicLabel: "10. Suara atau Musik:",
                soundMusicPlaceholder: "cth: musik orkestra epik, piano lembut, suara naga mengaum",
                spokenSentencesLabel: "11. Kalimat yang Diucapkan (Bahasa):",
                spokenSentencesPlaceholder: "cth: 'Waspadalah terhadap binatang buas itu, karena apinya menyala terang.'",
                additionalDetailsLabel: "12. Detail Tambahan (opsional):",
                additionalDetailsPlaceholder: "Detail spesifik tambahan, elemen, atau instruksi lainnya...",
                adAreaMiddle: "Area Iklan - Tengah",
                generateButton: "Buat Prompt Veo 3",
                generatedPromptOutputLabel: "Prompt yang Dihasilkan:",
                copyButton: "Salin Prompt",
                translatePromptButton: "Terjemahkan Prompt", // New translation key
                selectTranslationLanguagePlaceholder: "-- Pilih Bahasa --", // New translation key
                translatingPrompt: "Menerjemahkan prompt...", // New translation key for loading
                translatorErrorMessage: "Terjadi kesalahan saat menerjemahkan. Silakan coba lagi.", // New translation key for error
                adAreaBottom: "Area Iklan - Bawah",
                okButton: "OK",
                messageNoSubject: "Harap isi setidaknya Subjek untuk membuat prompt dasar.",
                messageCopied: "Prompt berhasil disalin!",
                manualCopyRequired: "Gagal menyalin secara otomatis. Harap salin teks secara manual.", // NEW TRANSLATION KEY
                darkModeOn: "Mode Gelap Aktif",
                darkModeOff: "Mode Gelap Nonaktif",
                languageToggleText: "English",
                visualPrefix: "Elemen visual",
                backgroundPrefix: "Detail latar belakang",
                dynamicCameraPrefix: "Interaksi kamera dinamis",
                soundDesignPrefix: "Desain suara",
                generativeFillSuggestionsTitle: "Saran Pengisian Generatif",
                endSuggestionsTitle: "Akhir Saran",
                darkModeText: "Mode Gelap", // New: Text for Dark Mode button in mobile menu
                languageText: "Bahasa", // New: Text for Language button in mobile menu
                addSubject: "Tambah Subjek", // New: Add Subject button text
                addSpokenSentence: "Tambah Kalimat", // New: Add Spoken Sentence button text
                remove: "Hapus", // New: Remove button text
                speakerPlaceholder: "cth: Karakter 1", // New: Speaker placeholder text
                saveSubjects: "Simpan Subjek", // New: Save Subjects button text
                loadSubjects: "Muat Subjek", // New: Load Subjects button text
                clearSubjects: "Hapus Subjek", // New: Clear Subjects button text
                savePlace: "Simpan Tempat", // New: Save Place button text
                loadPlace: "Muat Tempat", // New: Load Place button text
                clearPlace: "Hapus Tempat", // New: Clear Place button text
                inputsSaved: "Input berhasil disimpan!", // New: Message for saved inputs
                noSavedInputs: "Tidak ada input tersimpan.", // New: Message for no saved inputs
                inputsLoaded: "Input berhasil dimuat!", // New: Message for loaded inputs
                savedInputsCleared: "Input tersimpan dihapus!", // New: Message for cleared inputs
                randomizeButton: "Acak Prompt", // New: Randomize Button text
                clearAllInputsButton: "Hapus Prompt" // New: Clear All Inputs Button text
            }
            // Add more languages as needed
        };

        // Translations for prompt content (used by the generation logic)
        const promptContentTranslations = {
            id: {
                "A brave knight": "Seorang ksatria pemberani",
                "fighting a dragon": "melawan naga",
                "determined and focused": "bertekad dan fokus",
                "inside a dark cave": "di dalam gua yang gelap",
                "The scene depicts": "Adegan menggambarkan",
                "with a": "dengan",
                "in a": "dalam sebuah",
                "in": "di",
                "during the": "pada",
                "with": "dengan",
                "creating a": "menciptakan sebuah",
                "atmosphere": "atmosfer",
                "The camera employs a": "Kamera menggunakan sebuah",
                "movement.": "gerakan.",
                "Accompanied by": "Diiringi oleh",
                "Spoken sentences": "Kalimat yang diucapkan",
                "Additional details": "Detail tambahan",
                // Specific values for dropdowns when used in prompt sentences
                // These keys match the `value` property of the dropdown options directly
                "day": "siang",
                "morning": "pagi",
                "afternoon": "sore",
                "evening": "malam",
                "night": "malam",
                "golden hour": "jam emas",
                "blue hour": "jam biru",
                "soft natural light": "cahaya alami lembut",
                "dramatic chiaroscuro": "chiaroscuro dramatis",
                "neon glow": "cahaya neon",
                "backlight": "cahaya belakang",
                "rim light": "cahaya tepi",
                "low key": "low key",
                "high key": "high key",
                "Studio Ghibli inspired": "terinspirasi Studio Ghibli",
                "cyberpunk": "cyberpunk",
                "hyperrealistic": "sangat realistis",
                "impressionistic": "impresionistik",
                "anime": "anime",
                "cinematic": "sinematik",
                "documentary": "dokumenter",
                "vintage film": "film vintage",
                "stop motion": "stop motion",
                "serene": "tenang",
                "intense": "intens",
                "whimsical": "aneh/fantasi",
                "melancholic": "melankolis",
                "mysterious": "misterius",
                "thrilling": "mendebarkan",
                "peaceful": "damai",
                "chaotic": "kacau",

                "Visual elements": "Elemen visual",
                "Background details": "Detail latar belakang",
                "Dynamic camera interactions": "Interaksi kamera dinamis",
                "Sound design": "Desain suara",
                // Generative Fill Suggestions (English phrases from script) - now these keys match the `content` property of the objects
                "Sparks flying from the sword, scales glistening on the dragon's hide, smoke billowing from the dragon's nostrils.": "Percikan api dari pedang, sisik berkilauan di kulit naga, asap mengepul dari lubang hidung naga.",
                "Ancient runes glowing faintly on the cave walls, discarded armor from previous battles scattered around.": "Rune kuno bersinar redup di dinding gua, baju besi yang dibuang dari pertempuran sebelumnya tersebar di sekitar.",
                "Camera tracking the dragon's powerful wing beats as it soars, rapid cuts during the sword clashes to emphasize impact.": "Kamera melacak kepakan sayap naga yang perkasa saat melayang, potongan cepat selama bentrokan pedang untuk menekankan dampak.",
                "Close-up shots on the knight's determined eyes and the dragon's fiery breath.": "Close-up pada mata ksatria yang bertekad dan nafas naga yang berapi-api.",
                "A subtle smoke effect around the dragon, embers floating in the air.": "Efek asap halus di sekitar naga, bara api melayang di udara.",
                "The ground shaking with each of the dragon's steps.": "Tanah bergetar setiap langkah naga.",
                "A low-angle shot emphasizing the dragon's imposing size, followed by a quick pan to the knight's agility.": "Bidikan sudut rendah yang menekankan ukuran naga yang mengesankan, diikuti dengan pan cepat ke kelincahan ksatria.",
                "Raindrops glistening on the leaves, soft reflections on puddles.": "Tetesan hujan berkilau di daun, pantulan lembut di genangan air.",
                "Sunlight filtering through the canopy, subtle mist rising from the forest floor.": "Sinar matahari menyaring melalui kanopi, kabut halus naik dari dasar hutan.",
                "A slow dolly-out revealing the vastness of the forest, emphasizing the character's solitude.": "Dolly-out lambat yang memperlihatkan luasnya hutan, menekankan kesendirian karakter.",
                "Rustling of leaves, distant bird chirps, gentle breeze sounds.": "Desir daun, kicau burung di kejauhan, suara angin sepoi-sepoi.",
                "A vibrant, bustling city skyline at night, with neon signs reflecting on wet streets.": "Pemandangan kota yang semarak dan ramai di malam hari, dengan lampu neon memantul di jalanan basah.",
                "Futuristic vehicles whizzing by in the background, holographic advertisements flickering.": "Kendaraan futuristik melaju kencang di latar belakang, iklan holografik berkedip-kedip.",
                "Fast-paced tracking shots following subjects through the crowded streets, dynamic tilts capturing towering skyscrapers.": "Rekaman pelacakan cepat mengikuti subjek melalui jalan-jalan yang ramai, kemiringan dinamis yang menangkap gedung pencakar langit yang menjulang tinggi.",
                "Warm, inviting interior decor, soft glow from a fireplace or lamps.": "Dekorasi interior yang hangat dan mengundang, cahaya lembut dari perapian atau lampu.",
                "Cozy furniture arrangements, personal belongings that hint at the character's personality.": "Susunan furnitur yang nyaman, barang-barang pribadi yang mengisyaratkan kepribadian karakter.",
                "The gentle crackle of a fire, faint distant city sounds or quiet classical music.": "Desir lembut api, suara kota yang samar di kejauhan atau musik klasik yang tenang.",
                "A static shot focusing on the character's comfort, with subtle blurs in the background for depth.": "Bidikan statis yang berfokus pada kenyamanan karakter, dengan blur halus di latar belakang untuk kedalaman."
            }
            // Add more languages as needed
        };

        // Options for various select elements, now structured for dynamic population
        const timeOptions = [
            { value: "", en: "-- Select Time --", id: "-- Pilih Waktu --" },
            { value: "day", en: "Day", id: "Siang" },
            { value: "morning", en: "Morning", id: "Pagi" },
            { value: "afternoon", en: "Afternoon", id: "Sore" },
            { value: "evening", en: "Evening", id: "Malam" },
            { value: "night", en: "Night", id: "Malam" },
            { value: "golden hour", en: "Golden Hour", id: "Jam Emas" },
            { value: "blue hour", en: "Blue Hour", id: "Jam Biru" }
        ];

        // Camera Movement Options - This was missing and caused an error
        const cameraMovementOptions = [
            { value: "", en: "-- Select Camera Movement --", id: "-- Pilih Gerakan Kamera --" },
            { value: "pan", en: "Pan", id: "Pan" },
            { value: "tilt", en: "Tilt", id: "Tilt" },
            { value: "dolly", en: "Dolly", id: "Dolly" },
            { value: "zoom in", en: "Zoom In", id: "Zoom In" },
            { value: "zoom out", en: "Zoom Out", id: "Zoom Out" },
            { value: "tracking shot", en: "Tracking Shot", id: "Shot Pelacakan" },
            { value: "crane shot", en: "Crane Shot", id: "Shot Derek" },
            { value: "handheld", en: "Handheld", id: "Genggam" },
            { value: "static shot", en: "Static Shot", id: "Shot Statis" },
            { value: "dutch angle", en: "Dutch Angle", id: "Sudut Belanda" },
            { value: "POV (Point of View)", en: "POV (Point of View)", id: "POV (Sudut Pandang)" }
        ];

        const lightingOptions = [
            { value: "", en: "-- Select Lighting --", id: "-- Pilih Pencahayaan --" },
            { value: "soft natural light", en: "Soft Natural Light", id: "Cahaya Alami Lembut" },
            { value: "dramatic chiaroscuro", en: "Dramatic Chiaroscuro", id: "Chiaroscuro Dramatis" },
            { value: "neon glow", en: "Neon Glow", id: "Cahaya Neon" },
            { value: "backlight", en: "Backlight", id: "Cahaya Belakang" },
            { value: "rim light", en: "Rim Light", id: "Cahaya Tepi" },
            { value: "low key", en: "Low Key", id: "Low Key" },
            { value: "high key", en: "High Key", id: "High Key" }
        ];

        const videoStyleOptions = [
            { value: "", en: "-- Select Video Style --", id: "-- Pilih Gaya Video --" },
            { value: "Studio Ghibli inspired", en: "Studio Ghibli inspired", id: "Terinspirasi Studio Ghibli" },
            { value: "cyberpunk", en: "Cyberpunk", id: "Cyberpunk" },
            { value: "hyperrealistic", en: "Hyperrealistic", id: "Hiperrealistis" },
            { value: "impressionistic", en: "Impressionistic", id: "Impresionistik" },
            { value: "anime", en: "Anime", id: "Anime" },
            { value: "cinematic", en: "Cinematic", id: "Sinematik" },
            { value: "documentary", en: "Dokumenter", id: "Dokumenter" },
            { value: "vintage film", en: "Vintage Film", id: "Film Vintage" },
            { value: "stop motion", en: "Stop Motion", id: "Stop Motion" }
        ];

        const videoAtmosphereOptions = [
            { value: "", en: "-- Select Atmosphere --", id: "-- Pilih Atmosfer --" },
            { value: "serene", en: "Serene", id: "Tenang" },
            { value: "intense", en: "Intense", id: "Intens" },
            { value: "whimsical", en: "Whimsical", id: "Aneh/Fantasi" },
            { value: "melancholic", en: "Melancholic", id: "Melankolis" },
            { value: "mysterious", en: "Misterius", id: "Misterius" },
            { value: "thrilling", en: "Mendebarkan", id: "Mendebarkan" },
            { value: "peaceful", en: "Damai", id: "Damai" },
            { value: "chaotic", en: "Kacau", id: "Kacau" }
        ];


        // Options for the new prompt translator language select
        const promptTranslatorLanguageOptions = [
            { value: "en", en: "English", id: "English" },
            { value: "id", en: "Bahasa Indonesia", id: "Bahasa Indonesia" },
            { value: "es", en: "Español", id: "Español" },
            { value: "fr", en: "Français", id: "Français" },
            { value: "de", en: "Deutsch", id: "Deutsch" },
            { value: "ja", en: "日本語 (Japanese)", id: "日本語 (Japanese)" },
            { value: "ko", en: "한국어 (Korean)", id: "한국어 (Korean)" },
            { value: "zh", en: "中文 (Chinese)", id: "中文 (Chinese)" },
            { value: "ar", en: "العربية (Arabic)", id: "العربية (Arabic)" }
        ];

        // --- Random Data for Randomize Function ---
        const randomSubjects = ["Seorang astronot", "Kucing lucu", "Robot kuno", "Pahlawan super", "Seorang detektif", "Naga besar", "Burung kolibri", "Kapal bajak laut", "Ilmuwan gila", "Sinterklas", "Penyihir", "Petani", "Alien", "Vampir"];
        const randomActions = ["menjelajahi galaksi", "sedang tidur siang", "memperbaiki mesin", "melawan kejahatan", "mencari petunjuk", "terbang di atas gunung", "mengumpulkan nektar", "berlayar di lautan badai", "melakukan eksperimen", "mengantarkan hadiah", "meracik ramuan", "memanen sayuran", "mengamati manusia", "menari di bawah bulan"];
        const randomExpressions = ["penasaran", "damai", "bingung", "berani", "tajam", "marah", "sibuk", "tekun", "terkejut", "bahagia", "sedih", "santai", "khawatir", "ceria"];
        const randomPlaces = ["di planet asing", "di sofa nyaman", "di laboratorium rusak", "di kota futuristik", "di jalanan gelap", "di puncak gunung berapi", "di taman bunga", "di tengah badai laut", "di bengkel bawah tanah", "di kutub utara", "di hutan ajaib", "di ladang jagung", "di pesawat ruang angkasa", "di kastil tua"];
        const randomSoundMusic = ["musik orkestra epik", "dengkur kucing", "suara percikan api", "efek suara pertarungan", "musik misterius", "auman naga", "kicauan burung", "badai laut", "bunyi tabung reaksi", "lonceng rusa", "suara sihir", "suara alat pertanian", "suara bip", "suara kelelawar"];
        const randomSpeakers = ["John", "Sarah", "Dr. Chen", "Kapten Jack", "Narator", "Karakter Misterius", "Kakek", "Peri", "Makhluk Asing", "Vampir"];
        const randomSentences = [
            "Halo dunia.", "Apa kabar?", "Saya tidak tahu.", "Kita harus pergi.", "Lihat di sana!",
            "Waktu terus berjalan.", "Ini adalah akhir.", "Masa depan ada di tangan kita.", "Berhati-hatilah.",
            "Petualangan menanti.", "Jangan pernah menyerah.", "Percayalah pada dirimu.", "Keberanian adalah kunci.",
            "Cerita ini baru saja dimulai."
        ];
        const randomAdditionalDetails = [
            "dengan efek partikel yang detail", "warna cerah dan ceria", "gaya sinematik vintage", "dengan sudut pandang kamera yang rendah", "fokus pada detail wajah dan emosi",
            "background yang blur untuk kedalaman", "gerakan lambat untuk drama", "pencahayaan dramatis dan bayangan", "ada kilatan petir di kejauhan",
            "komposisi diagonal yang kuat", "filter warna hangat", "efek kabut halus", "kualitas 4K yang tajam", "gambar yang sangat detail"
        ];


        document.addEventListener('DOMContentLoaded', () => {
            // Get references to DOM elements for Veo 3 Prompt Generator
            const subjectInputsContainer = document.getElementById('subjectInputsContainer');
            const addSubjectBtn = document.getElementById('addSubjectBtn');
            const actionInput = document.getElementById('action');
            const expressionInput = document.getElementById('expression');
            const placeInput = document.getElementById('place');
            const timeSelect = document.getElementById('time');
            const cameraMovementSelect = document.getElementById('cameraMovement');
            const lightingSelect = document.getElementById('lighting');
            const videoStyleSelect = document.getElementById('videoStyle');
            const videoAtmosphereSelect = document.getElementById('videoAtmosphere');
            const soundMusicInput = document.getElementById('soundMusic');
            const spokenSentencesInputsContainer = document.getElementById('spokenSentencesInputsContainer');
            const addSpokenSentenceBtn = document.getElementById('addSpokenSentenceBtn');
            const additionalDetailsTextarea = document.getElementById('additionalDetails');

            const generateBtn = document.getElementById('generateBtn');
            const randomizeBtn = document.getElementById('randomizeBtn'); // New: Randomize button
            const clearAllInputsBtn = document.getElementById('clearAllInputsBtn'); // New: Clear All Inputs button
            const generatedPromptOutput = document.getElementById('generatedPromptOutput'); // Single output area
            const copyBtn = document.getElementById('copyBtn'); // New: Copy button
            const messageBox = document.getElementById('messageBox');
            const messageText = document.getElementById('messageText');
            const messageBoxClose = document.getElementById('messageBoxClose');

            // NEW: Separate Save/Load/Clear Buttons
            const saveSubjectsBtn = document.getElementById('saveSubjectsBtn');
            const loadSubjectsBtn = document.getElementById('loadSubjectsBtn');
            const clearSubjectsBtn = document.getElementById('clearSubjectsBtn');
            const savePlaceBtn = document.getElementById('savePlaceBtn');
            const loadPlaceBtn = document.getElementById('loadPlaceBtn');
            const clearPlaceBtn = document.getElementById('clearPlaceBtn');

            // Mobile Menu Elements
            const mobileMenuToggle = document.getElementById('mobileMenuToggle');
            const mobileMenuIcon = document.getElementById('mobileMenuIcon'); // Icon inside the toggle button
            const stackedMobileMenuContainer = document.getElementById('stackedMobileMenuContainer'); // New container for stacked items

            // Dark Mode and Language Toggle Buttons (now queried by class)
            const darkModeToggles = document.querySelectorAll('.dark-mode-toggle');
            const languageToggles = document.querySelectorAll('.language-toggle');

            // Icons for Dark Mode and Language (now queried by class)
            const darkModeIcons = document.querySelectorAll('.dark-mode-icon');
            const languageIcons = document.querySelectorAll('.language-icon');

            // New elements for Prompt Translator
            const translatePromptTargetLanguage = document.getElementById('translatePromptTargetLanguage');
            const translatePromptButton = document.getElementById('translatePromptButton');
            const promptTranslatorLoadingIndicator = document.getElementById('promptTranslatorLoadingIndicator');
            const promptTranslatorErrorMessage = document.getElementById('promptTranslatorErrorMessage');


            // --- Language Detection and Application (for Veo 3 and Translator) ---
            let currentLang = 'en'; // Default language

            /**
             * Detects the user's preferred language from the browser.
             * @returns {string} The detected language code (e.g., 'en', 'id').
             */
            function detectLanguage() {
                const browserLang = navigator.language || navigator.userLanguage;
                if (browserLang.startsWith('id')) {
                    return 'id';
                }
                return 'en'; // Fallback to English
            }

            /**
             * Populates a select element with options for the current language.
             * @param {HTMLElement} selectElement - The select element to populate.
             * @param {Array<Object>} optionsData - An array of option objects ({value, en, id}).
             * @param {string} lang - The current language ('en' or 'id').
             */
            function populateSelectOptions(selectElement, optionsData, lang) {
                const selectedValue = selectElement.value; // Save current selection
                selectElement.innerHTML = ''; // Clear existing options
                optionsData.forEach(optionData => {
                    const option = document.createElement('option');
                    option.value = optionData.value;
                    option.textContent = optionData[lang];
                    if (option.value === selectedValue) {
                        option.selected = true; // Restore selection
                    }
                    selectElement.appendChild(option);
                });
            }

            /**
             * Applies translations to UI elements based on the current language.
             * @param {string} lang - The language code to apply ('en' or 'id').
             */
            function applyUiTranslations(lang) {
                document.querySelectorAll('[data-i18n-key]').forEach(element => {
                    const key = element.getAttribute('data-i18n-key');
                    const translation = uiTranslations[lang][key];

                    if (translation) {
                        if (element.tagName === 'INPUT' && element.hasAttribute('placeholder')) {
                            element.placeholder = translation;
                        } else if (element.tagName === 'TEXTAREA' && element.hasAttribute('placeholder')) {
                            element.placeholder = translation;
                        } else if (element.tagName === 'TITLE') {
                            document.title = translation;
                        }
                        else {
                            element.textContent = translation;
                        }
                    }
                });

                // Dynamically populate all select options using their respective data arrays for Veo 3
                populateSelectOptions(timeSelect, timeOptions, lang);
                populateSelectOptions(cameraMovementSelect, cameraMovementOptions, lang);
                populateSelectOptions(lightingSelect, lightingOptions, lang);
                populateSelectOptions(videoStyleSelect, videoStyleOptions, lang);
                populateSelectOptions(videoAtmosphereSelect, videoAtmosphereOptions, lang);
                // Populate the new prompt translator language select
                populateSelectOptions(translatePromptTargetLanguage, promptTranslatorLanguageOptions, lang);

                // Update placeholders for dynamically added inputs
                document.querySelectorAll('.subject-input').forEach(input => {
                    input.placeholder = uiTranslations[currentLang].subjectPlaceholder;
                });
                document.querySelectorAll('.spoken-sentence-text').forEach(textarea => {
                    textarea.placeholder = uiTranslations[currentLang].spokenSentencesPlaceholder;
                });
                document.querySelectorAll('.speaker-input').forEach(input => {
                    input.placeholder = uiTranslations[currentLang].speakerPlaceholder;
                });
                document.querySelectorAll('.remove-btn').forEach(button => {
                    button.title = uiTranslations[currentLang].remove;
                    // Also update aria-label for accessibility
                    button.setAttribute('aria-label', uiTranslations[currentLang].remove + " input");
                });
            }

            currentLang = detectLanguage();
            applyUiTranslations(currentLang);

            // --- End Language Detection and Application ---


            // --- Dark Mode Logic ---
            /**
             * Sets the dark mode icon based on the current theme for all icons.
             */
            function setDarkModeIcons() {
                const isDarkMode = document.body.classList.contains('dark');
                darkModeIcons.forEach(icon => {
                    if (isDarkMode) {
                        icon.innerHTML = `<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path>`; // Moon icon
                    } else {
                        icon.innerHTML = `<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h1M4 12H3m15.325 3.325l-.707.707M6.372 6.372l-.707-.707m12.728 0l-.707.707M6.372 17.628l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path>`; // Sun icon
                    }
                });
            }

            /**
             * Toggles dark mode on/off.
             */
            function toggleDarkMode() {
                document.body.classList.toggle('dark');
                const isDarkMode = document.body.classList.contains('dark');
                localStorage.setItem('theme', isDarkMode ? 'dark' : 'light');
                setDarkModeIcons(); // Update all dark mode icons
            }

            // Apply saved theme or system preference on load
            const savedTheme = localStorage.getItem('theme');
            const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;

            if (savedTheme === 'dark' || (!savedTheme && prefersDark)) {
                document.body.classList.add('dark');
            }
            setDarkModeIcons(); // Set initial icons

            // Add event listeners to all dark mode toggle buttons
            darkModeToggles.forEach(button => {
                button.addEventListener('click', toggleDarkMode);
            });

            // --- End Dark Mode Logic ---

            // --- Language Toggle Logic ---
            languageToggles.forEach(button => {
                button.addEventListener('click', () => {
                    currentLang = currentLang === 'en' ? 'id' : 'en';
                    applyUiTranslations(currentLang);
                    if (generatedPromptOutput.value.trim() !== '') {
                        generateAndDisplayPrompt(); // Regenerate prompt in new UI language
                    }
                });
            });
            // --- End Language Toggle Logic ---


            /**
             * Displays a custom message box instead of alert().
             * @param {string} messageKey - The key for the message to display from uiTranslations.
             * @returns {void}
             */
            function showMessageBox(messageKey) {
                messageText.textContent = uiTranslations[currentLang][messageKey];
                messageBox.classList.remove('hidden');
                messageBox.querySelector('.transform').classList.remove('scale-95');
                messageBox.querySelector('.transform').classList.add('scale-100');
            }

            /**
             * Closes the custom message box.
             * @returns {void}
             */
            function closeMessageBox() {
                messageBox.querySelector('.transform').classList.remove('scale-100');
                messageBox.querySelector('.transform').classList.add('scale-95');
                setTimeout(() => {
                    messageBox.classList.add('hidden');
                }, 300); // Match transition duration
            }

            /**
             * Translates a prompt content phrase to the target language.
             * This function is specifically for the prompt *content* generation.
             * @param {string} englishPhrase - The English phrase to translate.
             * @param {string} targetLang - The language code to translate to (e.g., 'id').
             * @returns {string} The translated phrase, or the original if no translation.
             */
            function getPromptContentTranslation(englishPhrase, targetLang) {
                // For prompt content, we need to check if the exact English phrase is a key in promptContentTranslations[targetLang]
                // If not found, return the original English phrase.
                return promptContentTranslations[targetLang][englishPhrase] || englishPhrase;
            }

            /**
             * Handles copying the generated prompt to the clipboard.
             * This function attempts to use navigator.clipboard.writeText() first.
             * If it fails (e.g., due to iframe security policies), it falls back to document.execCommand('copy').
             * If both fail, it informs the user to copy manually.
             * @returns {void}
             */
            function copyPromptToClipboard() {
                const promptText = generatedPromptOutput.value;
                if (!promptText) {
                    // No text to copy
                    return;
                }

                // Directly use the fallback method to ensure compatibility within iframes
                tryCopyToClipboardFallback(promptText);
            }

            /**
             * Fallback function to copy text using document.execCommand.
             * Creates a temporary textarea, selects its content, and executes the copy command.
             * @param {string} text - The text to copy.
             */
            function tryCopyToClipboardFallback(text) {
                const textarea = document.createElement('textarea');
                textarea.value = text;
                textarea.style.position = 'fixed'; // Prevent scrolling to bottom of page
                textarea.style.left = '-9999px'; // Move off-screen
                document.body.appendChild(textarea);
                textarea.focus();
                textarea.select();
                try {
                    document.execCommand('copy');
                    showMessageBox('messageCopied');
                } catch (err) {
                    console.error('Failed to copy using document.execCommand:', err);
                    // Inform user to copy manually if both methods fail
                    showMessageBox('manualCopyRequired');
                } finally {
                    document.body.removeChild(textarea);
                }
            }

            /**
             * Adds a new subject input field.
             * @param {string} [initialValue=''] - Optional initial value for the input.
             */
            function addSubjectInput(initialValue = '') {
                const newDiv = document.createElement('div');
                newDiv.className = 'flex items-center gap-2';
                newDiv.innerHTML = `
                    <input class='flex-1 p-2 sm:p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-600 transition duration-200 shadow-sm subject-input' data-i18n-key='subjectPlaceholder' placeholder='${uiTranslations[currentLang].subjectPlaceholder}' type='text' value='${initialValue}'/>
                    <button class='p-2 rounded-full bg-red-500 text-white hover:bg-red-600 focus:outline-none focus:ring-2 focus:ring-red-400 transition duration-200 remove-btn' title='${uiTranslations[currentLang].remove}' aria-label="${uiTranslations[currentLang].remove} input">
                        <svg class='w-5 h-5' fill='none' stroke='currentColor' viewBox='0 0 24 24' xmlns='http://www.w3.org/2000/svg'><path stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M6 18L18 6M6 6l12 12'></path></svg>
                    </button>
                `;
                subjectInputsContainer.appendChild(newDiv);
                newDiv.querySelector('.remove-btn').addEventListener('click', () => newDiv.remove());
                // Add keypress listener to new input
                newDiv.querySelector('.subject-input').addEventListener('keypress', (event) => {
                    if (event.key === 'Enter') {
                        event.preventDefault();
                        generateAndDisplayPrompt();
                    }
                });
            }

            /**
             * Adds a new spoken sentence textarea field.
             * @param {string} [initialSpeaker=''] - Optional initial value for the speaker input.
             * @param {string} [initialSentence=''] - Optional initial value for the sentence textarea.
             */
            function addSpokenSentenceInput(initialSpeaker = '', initialSentence = '') {
                const newDiv = document.createElement('div');
                newDiv.className = 'flex items-start gap-2 spoken-sentence-group'; // Use items-start for textarea alignment
                newDiv.innerHTML = `
                    <input class='w-1/3 p-2 sm:p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-600 transition duration-200 shadow-sm speaker-input' data-i18n-key='speakerPlaceholder' placeholder='${uiTranslations[currentLang].speakerPlaceholder}' type='text' value='${initialSpeaker}'/>
                    <textarea class='flex-1 p-2 sm:p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-600 transition duration-200 resize-y shadow-sm spoken-sentence-text' data-i18n-key='spokenSentencesPlaceholder' placeholder='${uiTranslations[currentLang].spokenSentencesPlaceholder}' rows='2'>${initialSentence}</textarea>
                    <button class='p-2 rounded-full bg-red-500 text-white hover:bg-red-600 focus:outline-none focus:ring-2 focus:ring-red-400 transition duration-200 remove-btn' title='${uiTranslations[currentLang].remove}' aria-label="${uiTranslations[currentLang].remove} input">
                        <svg class='w-5 h-5' fill='none' stroke='currentColor' viewBox='0 0 24 24' xmlns='http://www.w3.org/2000/svg'><path stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M6 18L18 6M6 6l12 12'></path></svg>
                    </button>
                `;
                spokenSentencesInputsContainer.appendChild(newDiv);
                newDiv.querySelector('.remove-btn').addEventListener('click', () => newDiv.remove());
                // Add keypress listener to new textarea
                newDiv.querySelector('.spoken-sentence-text').addEventListener('keypress', (event) => {
                    if (event.key === 'Enter' && !event.shiftKey) { // Allow Shift+Enter for new line
                        event.preventDefault();
                        generateAndDisplayPrompt();
                    }
                });
                newDiv.querySelector('.speaker-input').addEventListener('keypress', (event) => {
                    if (event.key === 'Enter' && !event.shiftKey) {
                        event.preventDefault();
                        generateAndDisplayPrompt();
                    }
                });
            }

            /**
             * Saves current subject inputs to localStorage.
             */
            function saveSubjects() {
                const subjects = Array.from(document.querySelectorAll('.subject-input')).map(input => input.value.trim());
                localStorage.setItem('veo3_saved_subjects', JSON.stringify(subjects));
                showMessageBox('inputsSaved'); // Reusing a general message
            }

            /**
             * Loads saved subject inputs from localStorage.
             */
            function loadSubjects() {
                const savedSubjects = JSON.parse(localStorage.getItem('veo3_saved_subjects'));

                if (!savedSubjects || savedSubjects.length === 0) {
                    showMessageBox('noSavedInputs'); // Reusing a general message
                    return;
                }

                // Clear existing subject inputs first
                while (subjectInputsContainer.children.length > 1) { // Keep the initial input
                    subjectInputsContainer.removeChild(subjectInputsContainer.lastChild);
                }
                subjectInputsContainer.querySelector('.subject-input').value = ''; // Clear initial input

                // Fill the first input, then add more if needed
                if (savedSubjects.length > 0) {
                    subjectInputsContainer.querySelector('.subject-input').value = savedSubjects[0];
                }
                for (let i = 1; i < savedSubjects.length; i++) {
                    addSubjectInput(savedSubjects[i]);
                }
                showMessageBox('inputsLoaded'); // Reusing a general message
            }

            /**
             * Clears saved subject inputs from localStorage and resets form fields.
             */
            function clearSubjects() {
                localStorage.removeItem('veo3_saved_subjects');

                // Clear form fields
                while (subjectInputsContainer.children.length > 1) { // Keep the initial input
                    subjectInputsContainer.removeChild(subjectInputsContainer.lastChild);
                }
                subjectInputsContainer.querySelector('.subject-input').value = ''; // Clear initial input

                showMessageBox('savedInputsCleared'); // Reusing a general message
            }

            /**
             * Saves current place input to localStorage.
             */
            function savePlace() {
                const place = placeInput.value.trim();
                localStorage.setItem('veo3_saved_place', place);
                showMessageBox('inputsSaved'); // Reusing a general message
            }

            /**
             * Loads saved place input from localStorage.
             */
            function loadPlace() {
                const savedPlace = localStorage.getItem('veo3_saved_place');

                if (!savedPlace) {
                    showMessageBox('noSavedInputs'); // Reusing a general message
                    return;
                }

                placeInput.value = savedPlace;
                showMessageBox('inputsLoaded'); // Reusing a general message
            }

            /**
             * Clears saved place input from localStorage and resets form field.
             */
            function clearPlace() {
                localStorage.removeItem('veo3_saved_place');
                placeInput.value = '';
                showMessageBox('savedInputsCleared'); // Reusing a general message
            }

            /**
             * Selects a random element from an array.
             * @param {Array} arr - The array to select from.
             * @returns {*} A random element from the array.
             */
            function getRandomElement(arr) {
                return arr[Math.floor(Math.random() * arr.length)];
            }

            /**
             * Randomizes all input fields and select elements with predefined random data.
             * @param {Event} event - The click event object.
             */
            function randomizeInputs(event) {
                event.preventDefault(); // Prevent default button behavior (like scrolling)

                // Clear existing dynamic subject inputs (keep only the first one)
                while (subjectInputsContainer.children.length > 1) {
                    subjectInputsContainer.removeChild(subjectInputsContainer.lastChild);
                }
                // Clear the first subject input
                subjectInputsContainer.querySelector('.subject-input').value = '';

                // Add 1 to 3 random subjects
                const numSubjects = Math.floor(Math.random() * 3) + 1; // 1, 2, or 3 subjects
                for (let i = 0; i < numSubjects; i++) {
                    if (i === 0) { // Fill the initial input
                        subjectInputsContainer.querySelector('.subject-input').value = getRandomElement(randomSubjects);
                    } else {
                        addSubjectInput(getRandomElement(randomSubjects));
                    }
                }

                actionInput.value = getRandomElement(randomActions);
                expressionInput.value = getRandomElement(randomExpressions);
                placeInput.value = getRandomElement(randomPlaces);
                timeSelect.value = getRandomElement(timeOptions.filter(o => o.value !== '')).value;
                cameraMovementSelect.value = getRandomElement(cameraMovementOptions.filter(o => o.value !== '')).value;
                lightingSelect.value = getRandomElement(lightingOptions.filter(o => o.value !== '')).value;
                videoStyleSelect.value = getRandomElement(videoStyleOptions.filter(o => o.value !== '')).value;
                videoAtmosphereSelect.value = getRandomElement(videoAtmosphereOptions.filter(o => o.value !== '')).value;
                soundMusicInput.value = getRandomElement(randomSoundMusic);

                // Clear existing dynamic spoken sentences (keep only the first one)
                while (spokenSentencesInputsContainer.children.length > 1) {
                    spokenSentencesInputsContainer.removeChild(spokenSentencesInputsContainer.lastChild);
                }
                // Clear the first spoken sentence input
                spokenSentencesInputsContainer.querySelector('.speaker-input').value = '';
                spokenSentencesInputsContainer.querySelector('.spoken-sentence-text').value = '';

                // Add 0 to 3 random spoken sentences
                const numSentences = Math.floor(Math.random() * 4); // 0, 1, 2, or 3 sentences
                for (let i = 0; i < numSentences; i++) {
                    if (i === 0) { // Fill the initial input
                        spokenSentencesInputsContainer.querySelector('.speaker-input').value = getRandomElement(randomSpeakers);
                        spokenSentencesInputsContainer.querySelector('.spoken-sentence-text').value = getRandomElement(randomSentences);
                    } else {
                        addSpokenSentenceInput(getRandomElement(randomSpeakers), getRandomElement(randomSentences));
                    }
                }

                // Randomly add additional details or leave empty
                if (Math.random() > 0.5) { // 50% chance to add additional details
                    additionalDetailsTextarea.value = getRandomElement(randomAdditionalDetails);
                } else {
                    additionalDetailsTextarea.value = '';
                }

                // Generate and display the new prompt
                generateAndDisplayPrompt();
            }

            /**
             * Clears all input fields and the generated prompt output.
             */
            function clearAllInputs() {
                // Clear all subject inputs
                while (subjectInputsContainer.children.length > 1) {
                    subjectInputsContainer.removeChild(subjectInputsContainer.lastChild);
                }
                subjectInputsContainer.querySelector('.subject-input').value = '';

                // Clear single text inputs
                actionInput.value = '';
                expressionInput.value = '';
                placeInput.value = '';
                soundMusicInput.value = '';
                additionalDetailsTextarea.value = '';

                // Reset select elements to their default/first option
                timeSelect.value = '';
                cameraMovementSelect.value = '';
                lightingSelect.value = '';
                videoStyleSelect.value = '';
                videoAtmosphereSelect.value = '';

                // Clear all spoken sentence inputs
                while (spokenSentencesInputsContainer.children.length > 1) {
                    spokenSentencesInputsContainer.removeChild(spokenSentencesInputsContainer.lastChild);
                }
                spokenSentencesInputsContainer.querySelector('.speaker-input').value = '';
                spokenSentencesInputsContainer.querySelector('.spoken-sentence-text').value = '';

                // Clear the generated prompt output
                generatedPromptOutput.value = '';
            }


            /**
             * Generates and displays the prompt based on current inputs and selected language.
             * @returns {void}
             */
            function generateAndDisplayPrompt() {
                // Get trimmed values from all input and select fields
                const subjects = Array.from(document.querySelectorAll('.subject-input')).map(input => input.value.trim()).filter(Boolean);
                const action = actionInput.value.trim();
                const expression = expressionInput.value.trim();
                const place = placeInput.value.trim();
                const time = timeSelect.value;
                const cameraMovement = cameraMovementSelect.value;
                const lighting = lightingSelect.value;
                const videoStyle = videoStyleSelect.value;
                const videoAtmosphere = videoAtmosphereSelect.value;
                const soundMusic = soundMusicInput.value.trim();
                // Get all spoken sentences data (speaker and text)
                const spokenSentencesData = Array.from(document.querySelectorAll('.spoken-sentence-group')).map(group => {
                    const speaker = group.querySelector('.speaker-input').value.trim();
                    const sentence = group.querySelector('.spoken-sentence-text').value.trim();
                    return { speaker, sentence };
                }).filter(item => item.speaker || item.sentence); // Filter out empty groups
                const additionalDetails = additionalDetailsTextarea.value.trim();

                let englishPromptParts = [];
                let generativeFillSuggestionsEnglish = [];

                // Main narrative: Subject(s), Action, Expression, Place
                let mainNarrativeEnglish = [];
                if (subjects.length > 0) mainNarrativeEnglish.push(subjects.join(' and ')); // Join multiple subjects
                if (action) mainNarrativeEnglish.push(action);
                if (expression) mainNarrativeEnglish.push(`with a ${expression} expression`);
                if (place) mainNarrativeEnglish.push(`in ${place}`);

                if (mainNarrativeEnglish.length > 0) {
                    englishPromptParts.push(`The scene depicts ${mainNarrativeEnglish.join(' ')}.`);

                    // Generative Fill Suggestions based on primary inputs (English)
                    if (subjects.some(s => s.toLowerCase().includes("knight")) && action.toLowerCase().includes("dragon") && place.toLowerCase().includes("cave")) {
                        generativeFillSuggestionsEnglish.push({ type: "visual", content: "Sparks flying from the sword, scales glistening on the dragon's hide, smoke billowing from the dragon's nostrils." });
                        generativeFillSuggestionsEnglish.push({ type: "background", content: "Ancient runes glowing faintly on the cave walls, discarded armor from previous battles scattered around." });
                        generativeFillSuggestionsEnglish.push({ type: "dynamic_camera", content: "Camera tracking the dragon's powerful wing beats as it soars, rapid cuts during the sword clashes to emphasize impact." });
                        generativeFillSuggestionsEnglish.push({ type: "visual", content: "Close-up shots on the knight's determined eyes and the dragon's fiery breath." });
                        generativeFillSuggestionsEnglish.push({ type: "visual", content: "A subtle smoke effect around the dragon, embers floating in the air." });
                        generativeFillSuggestionsEnglish.push({ type: "background", content: "The ground shaking with each of the dragon's steps." });
                        generativeFillSuggestionsEnglish.push({ type: "dynamic_camera", content: "A low-angle shot emphasizing the dragon's imposing size, followed by a quick pan to the knight's agility." });
                    } else if (place.toLowerCase().includes("forest") || place.toLowerCase().includes("woods")) {
                        generativeFillSuggestionsEnglish.push({ type: "visual", content: "Raindrops glistening on the leaves, soft reflections on puddles." });
                        generativeFillSuggestionsEnglish.push({ type: "background", content: "Sunlight filtering through the canopy, subtle mist rising from the forest floor." });
                        generativeFillSuggestionsEnglish.push({ type: "dynamic_camera", content: "A slow dolly-out revealing the vastness of the forest, emphasizing the character's solitude." });
                        generativeFillSuggestionsEnglish.push({ type: "sound", content: "Rustling of leaves, distant bird chirps, gentle breeze sounds." });
                    } else if (place.toLowerCase().includes("city") || place.toLowerCase().includes("urban")) {
                        generativeFillSuggestionsEnglish.push({ type: "visual", content: "A vibrant, bustling city skyline at night, with neon signs reflecting on wet streets." });
                        generativeFillSuggestionsEnglish.push({ type: "background", content: "Futuristic vehicles whizzing by in the background, holographic advertisements flickering." });
                        generativeFillSuggestionsEnglish.push({ type: "dynamic_camera", content: "Fast-paced tracking shots following subjects through the crowded streets, dynamic tilts capturing towering skyscrapers." });
                    } else if (place.toLowerCase().includes("room") || place.toLowerCase().includes("house")) {
                        generativeFillSuggestionsEnglish.push({ type: "visual", content: "Warm, inviting interior decor, soft glow from a fireplace or lamps." });
                        generativeFillSuggestionsEnglish.push({ type: "background", content: "Cozy furniture arrangements, personal belongings that hint at the character's personality." });
                        generativeFillSuggestionsEnglish.push({ type: "sound", content: "The gentle crackle of a fire, faint distant city sounds or quiet classical music." });
                        generativeFillSuggestionsEnglish.push({ type: "dynamic_camera", content: "A static shot focusing on the character's comfort, with subtle blurs in the background for depth." });
                    }

                } else {
                    showMessageBox('messageNoSubject'); // Use translated message
                    return;
                }

                // Time, Camera Movement, Lighting, Video Style, Video Atmosphere
                let visualDetailsEnglish = [];
                // For dropdown values in prompt content, get their English text directly from the options data
                const selectedTimeTextEnglish = timeOptions.find(opt => opt.value === time)?.en || time;
                const selectedLightingTextEnglish = lightingOptions.find(opt => opt.value === lighting)?.en || lighting;
                const selectedVideoStyleTextEnglish = videoStyleOptions.find(opt => opt.value === videoStyle)?.en || videoStyle;
                const selectedVideoAtmosphereTextEnglish = videoAtmosphereOptions.find(opt => opt.value === videoAtmosphere)?.en || videoAtmosphere;


                if (time) visualDetailsEnglish.push(`during the ${selectedTimeTextEnglish.toLowerCase()}`); // Use the displayed text, convert to lowercase for natural flow
                if (lighting) visualDetailsEnglish.push(`with ${selectedLightingTextEnglish.toLowerCase()} lighting`);
                if (videoStyle) visualDetailsEnglish.push(`in a ${selectedVideoStyleTextEnglish.toLowerCase()} video style`);
                if (videoAtmosphere) visualDetailsEnglish.push(`creating a ${selectedVideoAtmosphereTextEnglish.toLowerCase()} atmosphere`);

                if (visualDetailsEnglish.length > 0) {
                    englishPromptParts.push(visualDetailsEnglish.join(', ') + '.');
                }

                if (cameraMovement) {
                    const selectedCameraMovementTextEnglish = cameraMovementOptions.find(opt => opt.value === cameraMovement)?.en || cameraMovement;
                    englishPromptParts.push(`The camera employs a ${selectedCameraMovementTextEnglish.toLowerCase()} movement.`);
                }

                if (soundMusic) {
                    englishPromptParts.push(`Accompanied by ${soundMusic}.`);
                }

                // Spoken Sentences - format as a comma-separated list of quoted strings
                if (spokenSentencesData.length > 0) {
                    const formattedSentences = spokenSentencesData.map(item => {
                        return item.speaker ? `${item.speaker}: "${item.sentence}"` : `"${item.sentence}"`;
                    }).join(', ');
                    englishPromptParts.push(`Spoken sentences: ${formattedSentences}`);
                }

                // Generative Fill Suggestions (if any)
                if (generativeFillSuggestionsEnglish.length > 0) {
                    englishPromptParts.push('\n--- ' + uiTranslations['en'].generativeFillSuggestionsTitle + ' ---');
                    generativeFillSuggestionsEnglish.forEach(suggestion => {
                        let prefix = "";
                        if (suggestion.type === "visual") {
                            prefix = uiTranslations['en'].visualPrefix;
                        } else if (suggestion.type === "background") {
                            prefix = uiTranslations['en'].backgroundPrefix;
                        } else if (suggestion.type === "dynamic_camera") {
                            prefix = uiTranslations['en'].dynamicCameraPrefix;
                        } else if (suggestion.type === "sound") {
                            prefix = uiTranslations['en'].soundDesignPrefix;
                        }
                        englishPromptParts.push(`- ${prefix}: ${suggestion.content}`);
                    });
                    englishPromptParts.push('--- ' + uiTranslations['en'].endSuggestionsTitle + ' ---');
                }


                // Additional Details
                if (additionalDetails) {
                    englishPromptParts.push(`Additional details: ${additionalDetails}.`);
                }

                const finalEnglishPrompt = englishPromptParts.filter(part => part !== '').join('\n'); // Join with newlines for readability

                // --- Generate Indonesian Prompt ---
                let indonesianPromptParts = [];
                let generativeFillSuggestionsIndonesian = [];

                let mainNarrativeIndonesian = [];
                if (subjects.length > 0) mainNarrativeIndonesian.push(subjects.map(s => getPromptContentTranslation(s, 'id')).join(' dan ')); // Join multiple translated subjects
                if (action) mainNarrativeIndonesian.push(getPromptContentTranslation(action, 'id'));
                if (expression) mainNarrativeIndonesian.push(`dengan ekspresi ${getPromptContentTranslation(expression, 'id')}`);
                if (place) mainNarrativeIndonesian.push(`di ${getPromptContentTranslation(place, 'id')}`);

                if (mainNarrativeIndonesian.length > 0) {
                    indonesianPromptParts.push(getPromptContentTranslation("The scene depicts", 'id') + ` ${mainNarrativeIndonesian.join(' ')}.`);

                    // Translate generative fill suggestions for Indonesian output
                    if (subjects.some(s => s.toLowerCase().includes("knight")) && action.toLowerCase().includes("dragon") && place.toLowerCase().includes("cave")) {
                        generativeFillSuggestionsIndonesian.push({ type: "visual", content: getPromptContentTranslation("Sparks flying from the sword, scales glistening on the dragon's hide, smoke billowing from the dragon's nostrils.", 'id') });
                        generativeFillSuggestionsIndonesian.push({ type: "background", content: getPromptContentTranslation("Ancient runes glowing faintly on the cave walls, discarded armor from previous battles scattered around.", 'id') });
                        generativeFillSuggestionsIndonesian.push({ type: "dynamic_camera", content: getPromptContentTranslation("Camera tracking the dragon's powerful wing beats as it soars, rapid cuts during the sword clashes to emphasize impact.", 'id') });
                        generativeFillSuggestionsIndonesian.push({ type: "visual", content: getPromptContentTranslation("Close-up shots on the knight's determined eyes and the dragon's fiery breath.", 'id') });
                        generativeFillSuggestionsIndonesian.push({ type: "visual", content: getPromptContentTranslation("A subtle smoke effect around the dragon, embers floating in the air.", 'id') });
                        generativeFillSuggestionsIndonesian.push({ type: "background", content: getPromptContentTranslation("The ground shaking with each of the dragon's steps.", 'id') });
                        generativeFillSuggestionsIndonesian.push({ type: "dynamic_camera", content: getPromptContentTranslation("A low-angle shot emphasizing the dragon's imposing size, followed by a quick pan to the knight's agility.", 'id') });
                    } else if (place.toLowerCase().includes("forest") || place.toLowerCase().includes("woods")) {
                        generativeFillSuggestionsIndonesian.push({ type: "visual", content: getPromptContentTranslation("Raindrops glistening on the leaves, soft reflections on puddles.", 'id') });
                        generativeFillSuggestionsIndonesian.push({ type: "background", content: getPromptContentTranslation("Sunlight filtering through the canopy, subtle mist rising from the forest floor.", 'id') });
                        generativeFillSuggestionsIndonesian.push({ type: "dynamic_camera", content: getPromptContentTranslation("A slow dolly-out revealing the vastness of the forest, emphasizing the character's solitude.", 'id') });
                        generativeFillSuggestionsIndonesian.push({ type: "sound", content: getPromptContentTranslation("Rustling of leaves, distant bird chirps, gentle breeze sounds.", 'id') });
                    } else if (place.toLowerCase().includes("city") || place.toLowerCase().includes("urban")) {
                        generativeFillSuggestionsIndonesian.push({ type: "visual", content: getPromptContentTranslation("A vibrant, bustling city skyline at night, with neon signs reflecting on wet streets.", 'id') });
                        generativeFillSuggestionsIndonesian.push({ type: "background", content: getPromptContentTranslation("Futuristic vehicles whizzing by in the background, holographic advertisements flickering.", 'id') });
                        generativeFillSuggestionsIndonesian.push({ type: "dynamic_camera", content: getPromptContentTranslation("Fast-paced tracking shots following subjects through the crowded streets, dynamic tilts capturing towering skyscrapers.", 'id') });
                    } else if (place.toLowerCase().toLowerCase().includes("room") || place.toLowerCase().includes("house")) {
                        generativeFillSuggestionsIndonesian.push({ type: "visual", content: getPromptContentTranslation("Warm, inviting interior decor, soft glow from a fireplace or lamps.", 'id') });
                        generativeFillSuggestionsIndonesian.push({ type: "background", content: getPromptContentTranslation("Cozy furniture arrangements, personal belongings that hint at the character's personality.", 'id') });
                        generativeFillSuggestionsIndonesian.push({ type: "sound", content: getPromptContentTranslation("The gentle crackle of a fire, faint distant city sounds or quiet classical music.", 'id') });
                        generativeFillSuggestionsIndonesian.push({ type: "dynamic_camera", content: getPromptContentTranslation("A static shot focusing on the character's comfort, with subtle blurs in the background for depth.", 'id') });
                    }

                }

                let visualDetailsIndonesian = [];
                // For dropdown values in prompt content, get their ID translation directly from the options data
                const selectedTimeTextIndonesian = timeOptions.find(opt => opt.value === time)?.id || time;
                const selectedLightingTextIndonesian = lightingOptions.find(opt => opt.value === lighting)?.id || lighting;
                const selectedVideoStyleTextIndonesian = videoStyleOptions.find(opt => opt.value === videoStyle)?.id || videoStyle;
                const selectedVideoAtmosphereTextIndonesian = videoAtmosphereOptions.find(opt => opt.value === videoAtmosphere)?.id || videoAtmosphere;


                if (time) visualDetailsIndonesian.push(`pada ${selectedTimeTextIndonesian.toLowerCase()}`);
                if (lighting) visualDetailsIndonesian.push(`dengan ${selectedLightingTextIndonesian.toLowerCase()} pencahayaan`);
                if (videoStyle) visualDetailsIndonesian.push(`dalam gaya video ${selectedVideoStyleTextIndonesian.toLowerCase()}`);
                if (videoAtmosphere) visualDetailsIndonesian.push(`menciptakan ${selectedVideoAtmosphereTextIndonesian.toLowerCase()} suasana`);

                if (visualDetailsIndonesian.length > 0) {
                    indonesianPromptParts.push(visualDetailsIndonesian.join(', ') + '.');
                }

                if (cameraMovement) {
                    // Get the ID translation directly from the cameraMovementOptions array
                    const selectedCameraMovementOption = cameraMovementOptions.find(opt => opt.value === cameraMovement);
                    const indonesianCameraMovement = selectedCameraMovementOption ? selectedCameraMovementOption.id : cameraMovement;
                    indonesianPromptParts.push(`Kamera menggunakan gerakan ${indonesianCameraMovement}.`);
                }

                if (soundMusic) {
                    indonesianPromptParts.push(`Diiringi oleh ${getPromptContentTranslation(soundMusic, 'id')}.`);
                }

                // Spoken sentences will not be translated. It will remain in its original form.
                if (spokenSentencesData.length > 0) {
                    const formattedSentences = spokenSentencesData.map(item => {
                        return item.speaker ? `${item.speaker}: "${item.sentence}"` : `"${item.sentence}"`;
                    }).join(', ');
                    indonesianPromptParts.push(`Kalimat yang diucapkan: ${formattedSentences}`);
                }

                // Generative Fill Suggestions (if any)
                if (generativeFillSuggestionsIndonesian.length > 0) {
                    indonesianPromptParts.push('\n--- ' + uiTranslations['id'].generativeFillSuggestionsTitle + ' ---');
                    generativeFillSuggestionsIndonesian.forEach(suggestion => {
                        let prefix = "";
                        if (suggestion.type === "visual") {
                            prefix = uiTranslations['id'].visualPrefix;
                        } else if (suggestion.type === "background") {
                            prefix = uiTranslations['id'].backgroundPrefix;
                        } else if (suggestion.type === "dynamic_camera") {
                            prefix = uiTranslations['id'].dynamicCameraPrefix;
                        } else if (suggestion.type === "sound") {
                            prefix = uiTranslations['id'].soundDesignPrefix;
                        }
                        indonesianPromptParts.push(`- ${prefix}: ${suggestion.content}`); // content is already translated here
                    });
                    indonesianPromptParts.push('--- ' + uiTranslations['id'].endSuggestionsTitle + ' ---');
                }

                if (additionalDetails) {
                    indonesianPromptParts.push(getPromptContentTranslation("Additional details", 'id') + `: ${getPromptContentTranslation(additionalDetails, 'id')}.`);
                }

                const finalIndonesianPrompt = indonesianPromptParts.filter(part => part !== '').join('\n'); // Join with newlines for readability

                // Display the appropriate prompt based on current language
                if (currentLang === 'id') {
                    generatedPromptOutput.value = finalIndonesianPrompt;
                } else {
                    generatedPromptOutput.value = finalEnglishPrompt;
                }

                // Focus and select the generated prompt for easy copying
                generatedPromptOutput.focus();
                generatedPromptOutput.select();
            }


            // Event listener for the "Generate Prompt" button
            generateBtn.addEventListener('click', generateAndDisplayPrompt);

            // Add new subject input
            addSubjectBtn.addEventListener('click', () => addSubjectInput('')); // Pass empty string for new input

            // Add new spoken sentence input
            addSpokenSentenceBtn.addEventListener('click', () => addSpokenSentenceInput('', '')); // Pass empty strings for new inputs


            // New: Event listener for the "Copy Prompt" button
            copyBtn.addEventListener('click', copyPromptToClipboard);

            // NEW: Event listeners for Save/Load/Clear buttons
            saveSubjectsBtn.addEventListener('click', saveSubjects);
            loadSubjectsBtn.addEventListener('click', loadSubjects);
            clearSubjectsBtn.addEventListener('click', clearSubjects);
            savePlaceBtn.addEventListener('click', savePlace);
            loadPlaceBtn.addEventListener('click', loadPlace);
            clearPlaceBtn.addEventListener('click', clearPlace);
            // NEW: Event listener for Randomize button
            randomizeBtn.addEventListener('click', randomizeInputs);
            // NEW: Event listener for Clear All Inputs button
            clearAllInputsBtn.addEventListener('click', clearAllInputs);


            // Event listener for the message box close button
            messageBoxClose.addEventListener('click', closeMessageBox);

            // Initial setup for existing input fields
            // Select all existing input fields by their classes to add event listeners
            document.querySelector('.subject-input').addEventListener('keypress', (event) => {
                if (event.key === 'Enter') {
                    event.preventDefault();
                    generateAndDisplayPrompt();
                }
            });
            document.querySelector('.spoken-sentence-text').addEventListener('keypress', (event) => {
                if (event.key === 'Enter' && !event.shiftKey) { // Allow Shift+Enter for new line
                    event.preventDefault();
                    generateAndDisplayPrompt();
                }
            });
            document.querySelector('.speaker-input').addEventListener('keypress', (event) => { // Initial speaker input
                if (event.key === 'Enter' && !event.shiftKey) {
                    event.preventDefault();
                    generateAndDisplayPrompt();
                }
            });

            // Standard input/textarea event listeners
            actionInput.addEventListener('keypress', (event) => { if (event.key === 'Enter') { event.preventDefault(); generateAndDisplayPrompt(); } });
            expressionInput.addEventListener('keypress', (event) => { if (event.key === 'Enter') { event.preventDefault(); generateAndDisplayPrompt(); } });
            placeInput.addEventListener('keypress', (event) => { if (event.key === 'Enter') { event.preventDefault(); generateAndDisplayPrompt(); } });
            soundMusicInput.addEventListener('keypress', (event) => { if (event.key === 'Enter') { event.preventDefault(); generateAndDisplayPrompt(); } });
            additionalDetailsTextarea.addEventListener('keypress', (event) => {
                if (event.key === 'Enter' && !event.shiftKey) {
                    event.preventDefault();
                    generateAndDisplayPrompt();
                }
            });


            // --- Start of Prompt Translator Logic ---
            // Gemini API key - IMPORTANT: Replace with your actual Gemini API Key!
            const apiKey = "AIzaSyBHdtH73rkwHRFzBt-PfctM9_XPyUBQ91Y"; // If you want to use models other than gemini-2.0-flash or imagen-3.0-generate-002, provide an API key here. Otherwise, leave this as-is.
            // Endpoint URL for the Gemini 2.0 Flash model
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

            // Function to handle translation of the generated prompt
            async function translateGeneratedPrompt() {
                const textToTranslate = generatedPromptOutput.value.trim();
                const targetLanguage = translatePromptTargetLanguage.value;

                // Hide previous error messages
                promptTranslatorErrorMessage.classList.add('hidden');

                if (!textToTranslate) {
                    showMessageBox('messageNoSubject'); // Use existing message
                    return;
                }
                
                if (apiKey === "YOUR_GEMINI_API_KEY_HERE" || !apiKey) {
                    promptTranslatorErrorMessage.textContent = uiTranslations[currentLang].translatorErrorMessage + ": Gemini API Key not found. Please provide your API Key to use the translation feature.";
                    promptTranslatorErrorMessage.classList.remove('hidden');
                    return;
                }


                // Show loading indicator and disable buttons
                promptTranslatorLoadingIndicator.classList.remove('hidden');
                translatePromptButton.disabled = true;
                copyBtn.disabled = true; // Disable copy button as well
                generateBtn.disabled = true; // Disable generate during translation
                randomizeBtn.disabled = true; // Disable randomize during translation


                try {
                    let chatHistory = [];
                    // Construct the prompt for the Gemini model
                    // Specific instruction to keep "Spoken sentences:" and "NAME: "SENTENCE"" patterns untranslated.
                    const prompt = `Translate the following text to language ${targetLanguage}.
IMPORTANT: Any line that starts with "Spoken sentences:" or contains the pattern "NAME: "SENTENCE"" (e.g., "John: "Hello"") should NOT be translated. Preserve such lines exactly as they are in the original.
Only provide the translated text, without additional explanation or Markdown formatting.

"${textToTranslate}"`;
                    chatHistory.push({ role: "user", parts: [{ text: prompt }] });

                    const payload = { contents: chatHistory };

                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    const result = await response.json();

                    if (result.candidates && result.candidates.length > 0 &&
                        result.candidates[0].content && result.candidates[0].content.parts &&
                        result.candidates[0].content.parts.length > 0) {
                        const translatedText = result.candidates[0].content.parts[0].text;
                        generatedPromptOutput.value = translatedText; // Update the output textarea directly
                    } else {
                        console.error('Unexpected API response structure:', result);
                        promptTranslatorErrorMessage.textContent = uiTranslations[currentLang].translatorErrorMessage; // Use translated message
                        promptTranslatorErrorMessage.classList.remove('hidden');
                    }
                } catch (error) {
                    console.error('Error during translation:', error);
                    promptTranslatorErrorMessage.textContent = uiTranslations[currentLang].translatorErrorMessage; // Use translated message
                    promptTranslatorErrorMessage.classList.remove('hidden');
                } finally {
                    // Hide loading indicator and re-enable buttons
                    promptTranslatorLoadingIndicator.classList.add('hidden');
                    translatePromptButton.disabled = false;
                    copyBtn.disabled = false;
                    generateBtn.disabled = false;
                    randomizeBtn.disabled = false;
                }
            }

            // Event listener for the "Translate Prompt" button
            translatePromptButton.addEventListener('click', translateGeneratedPrompt);

            // --- Mobile Menu Logic ---
            let isMobileMenuOpen = false;

            function toggleMobileMenu() {
                isMobileMenuOpen = !isMobileMenuOpen;
                if (isMobileMenuOpen) {
                    stackedMobileMenuContainer.classList.remove('hidden'); // Show container initially
                    setTimeout(() => { // Allow reflow before animating
                        stackedMobileMenuContainer.classList.add('is-open');
                    }, 10);
                    mobileMenuIcon.innerHTML = `<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>`; // Change to X icon
                } else {
                    stackedMobileMenuContainer.classList.remove('is-open');
                    setTimeout(() => { // Hide after animation
                        stackedMobileMenuContainer.classList.add('hidden');
                    }, 300); // Match transition duration
                    mobileMenuIcon.innerHTML = `<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>`; // Change back to hamburger icon
                }
            }

            if (mobileMenuToggle && stackedMobileMenuContainer && mobileMenuIcon) {
                mobileMenuToggle.addEventListener('click', toggleMobileMenu);
            }
            // --- End Mobile Menu Logic ---
        });
